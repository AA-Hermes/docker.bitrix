version: "3.0"

volumes:
    db:
        driver: local
    cache:
        driver: local

networks:
    back:
        driver: bridge
    proxy-network:
        name: nginx-proxy_default
        external: true

services:
    server:
        env_file: .env
        build: ./config/${WEB_SERVER_TYPE}
        container_name: ${PROJECT_NAME}-${WEB_SERVER_TYPE}
        volumes:
            - ${SITE_PATH}:/var/www/bitrix
            - db:/var/lib/mysql
            - ./logs/${WEB_SERVER_TYPE}:/var/log/${WEB_SERVER_TYPE}
        expose:
            - 80
            - 443
        links:
            - php
            - db
        networks:
            - back
            - proxy-network
        restart: always
    php:
        env_file: .env
        build: ./config/php/${PHP_VERSION}
        container_name: ${PROJECT_NAME}-php${PHP_VERSION}
        volumes:
            - ${SITE_PATH}:/var/www/bitrix
            - db:/var/lib/mysql
            - ./logs/php:/var/log/php
            - ./logs/xdebug:/tmp
            # bitrix template
            - ./config/bitrix/:/var/www/bitrix/
            # - ./config/bitrix/bitrix_server_test.php:/var/www/bitrix/bitrix_server_test.php
            # - ./config/bitrix/bitrixsetup.php:/var/www/bitrix/bitrixsetup.php
            # - ./config/bitrix/.htaccess:/var/www/bitrix/.htaccess
            # - ./config/bitrix/.gitignore:/var/www/bitrix/.gitignore
            # - ./config/bitrix/.gitmodules:/var/www/bitrix/.gitmodules
        links:
            - db
            - memcached
        networks:
            - back
        restart: always
    db:
        env_file: .env
        build: ./config/${DB_SERVER_TYPE}
        container_name: ${PROJECT_NAME}-${DB_SERVER_TYPE}
        volumes:
            - db:/var/lib/mysql
            - ./logs/db:/var/log/mysql
        expose:
            - 3306
        networks:
            - back
        restart: always
    memcached:
        env_file: .env
        build: ./config/memcached
        # image: memcached:1.5-alpine
        container_name: ${PROJECT_NAME}-memcached
        volumes:
            - cache:/var/lib/memcached
            - ./logs/memcached:/var/log/memcached
        expose:
            - 11211
        networks:
            - back
        restart: always
