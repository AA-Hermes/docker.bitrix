version: "3.0"

volumes:
    db:
        driver: local
    cache:
        driver: local

networks:
    back:
        driver: bridge
    proxy-network:
        name: nginx-proxy_default
        external: true

services:
    server:
        env_file: .env
        build: ./config/${WEB_SERVER_TYPE}
        container_name: ${PROJECT_NAME}-${WEB_SERVER_TYPE}
        volumes:
            - ${SITE_PATH}:/var/www/bitrix
            - db:/var/lib/mysql
            - ./logs/${WEB_SERVER_TYPE}:/var/log/${WEB_SERVER_TYPE}
        expose:
            - 80
            - 443
        links:
            - php
            - db
        networks:
            - back
            - proxy-network
        restart: always
    php:
        env_file: .env
        build: ./config/php/${PHP_VERSION}
        container_name: ${PROJECT_NAME}-php${PHP_VERSION}
        volumes:
            - ${SITE_PATH}:/var/www/bitrix
            - db:/var/lib/mysql
            - ./logs/php:/var/log/php
            - ./logs/xdebug:/tmp
        links:
            - db
            - memcached
        networks:
            - back
        restart: always
    db:
        env_file: .env
        build: ./config/${DB_SERVER_TYPE}
        container_name: ${PROJECT_NAME}-${DB_SERVER_TYPE}
        volumes:
            - db:/var/lib/mysql
            - ./logs/db:/var/log/mysql
        expose:
            - 3306
        networks:
            - back
        restart: always
    # pma:
    #     image: phpmyadmin
    #     expose:
    #         - 8080
    #     environment:
    #         - PMA_ARBITRARY=1
    #     networks:
    #         - default
    #     restart: always
    memcached:
        env_file: .env
        build: ./config/memcached
        # image: memcached:1.5-alpine
        container_name: ${PROJECT_NAME}-memcached
        volumes:
            - cache:/var/lib/memcached
            - ./logs/memcached:/var/log/memcached
        expose:
            - 11211
        networks:
            - back
        restart: always
